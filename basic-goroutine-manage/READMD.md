# basic-goroutine-manage
생성한 고루틴을 관리하기 위한 기본 코드 및 패턴

고루틴 생성 후 오랫동안 실행되고(사실상 무한) 특정 이벤트 발생 시 생성한 고루틴을 종료할 때 유용하며 특히 생성한 고루틴이 모두 종료될때까지 대기할 필요가 있을 때 사용

이 패턴을 사용하기 이전에는 플래그나 채널을 사용하였으나 플래그는 여러 고루틴이 동시에 사용하려면 Lock을 이용해 관리해야하고 채널은 생성한 고루틴만큼 데이터를 넣어줘야함 (*채널을 닫는 방식으로도 관리가 가능)

## 관리 방식
1. sync.WaitGroup, context.Context 변수 생성
2. 고루틴(async_task)을 생성할 때마다 2개 변수를 넘기고 WaitGroup.Add(1) 호출
3. 외부 요인(코드에서는 10초 대기 후 취소 함수를 호출하는 고루틴)에 의해 취소 함수(cancelFn) 호출
4. 고루틴(async_task)에서 실행 중 Context.Done() 채널이 닫혀 해당 case를 타게됨
5. 고루틴(async_task)에서 case 진행 후 return 직전 WaitGroup.Done() 함수를 호출 후 종료
6. 메인 함수에서는 생성한 WaitGroup을 이용해 대기하던 중 WaitGroup의 카운터가 0이 되어 대기 종료

## 계기
업무에서 메세지 큐 서버에서 메세지를 가져와 처리하는 프로그램을 작성하였으나 메세지 큐 서버 연결이 간헐적으로 끊기는 현상이 존재하였다.

연결이 끊기면 기존 작업은 종료하고 다시 재연결 후 작업을 재시작 해야하나 불완전한 코드로 인해 재연결 후 기존에 생성한 고루틴이 남아있는 이슈가 존재하였다.

이를 해결하기 위해 고루틴을 관리하는 방법을 조사하여 작성하였다.